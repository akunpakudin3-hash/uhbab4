<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBT Informatika - Standar Ujian</title>
    
    <!-- 1. LIBRARY -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- 2. FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. CONFIG STYLE -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        cbtBlue: '#2563eb', 
                        cbtDark: '#1e293b',
                        cbtRed: '#ef4444',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #e2e8f0; font-size: 14px; user-select: none; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .question-text { font-size: 16px; line-height: 1.8; text-align: justify; }
        .question-highlight { background-color: #f8fafc; border-left: 4px solid #2563eb; padding: 12px; margin-bottom: 16px; border-radius: 4px; font-style: italic; color: #475569; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        // --- KONFIGURASI DATABASE ---
        const SUPABASE_URL = "https://qikeneczlyvbjprnhxyl.supabase.co"; 
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFpa2VuZWN6bHl2Ympwcm5oeHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MDM1MTYsImV4cCI6MjA4NjE3OTUxNn0.qRdHiFNMOnxYDOLz9Q-CsistIrYn0GT7HXX4FNkD1d4"; 
        
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined') supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) { console.error("Supabase Error:", e); }

        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        const Icons = {
            User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            Lock: <><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
            Check: <polyline points="20 6 9 17 4 12"/>,
            X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            Menu: <><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></>,
            Left: <polyline points="15 18 9 12 15 6"/>,
            Right: <polyline points="9 18 15 12 9 6"/>,
            Alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            LogOut: <><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>,
            Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
            Eye: <><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>,
            Loader: <path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83" />
        };

        // --- BANK SOAL HOTS (JEJAK DIGITAL) ---
        const INITIAL_QUESTIONS = [
            // --- A. PILIHAN GANDA ---
            { 
                id: 1, category: 'mc', type: 'choice', 
                question: "Studi Kasus: Dina memposting status kasar di media sosial karena kesal, lalu menghapusnya 15 menit kemudian. Namun, tangkapan layar status itu tetap menyebar. Berdasarkan sifat jejak digital, mengapa tindakan penghapusan 'Delete' tidak efektif?", 
                options: [
                    "Server media sosial selalu error saat menghapus.", 
                    "Jejak digital bersifat persisten; konten bisa disalin (screenshot) atau diarsipkan server sebelum dihapus.", 
                    "Internet memiliki memori tak terbatas.", 
                    "Dina menggunakan akun asli, bukan anonim."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 2, category: 'mc', type: 'choice', 
                question: "Situasi: Budi mengunggah foto 'Boarding Pass' ke Instagram Story dengan menutupi nama penumpangnya. Temannya memperingatkan bahwa itu tetap berbahaya. Analisislah risiko keamanan yang tersisa!", 
                options: [
                    "Orang tahu rumah Budi kosong.", 
                    "Kode Barcode/QR pada tiket masih terlihat dan dapat dipindai untuk mencuri data sensitif (NIK).", 
                    "Stiker penutup bisa hilang.", 
                    "Maskapai akan membatalkan tiket otomatis."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 3, category: 'mc', type: 'choice', 
                question: "Fenomena: Setelah mencari 'Laptop Gaming' di Google, media sosial seorang siswa dipenuhi iklan laptop. Mekanisme jejak digital apa yang bekerja?", 
                options: [
                    "Jejak Digital Aktif.", 
                    "Jejak Digital Pasif (Cookies & Algoritma Pelacakan).", 
                    "Penyadapan Ilegal.", 
                    "Kebetulan Semata."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 4, category: 'mc', type: 'choice', 
                question: "Analisis: Kamu menerima pesan WA berisi link: 'http://internet-kemdikbud-gratis.xyz'. Langkah nalar kritis pertama untuk verifikasi?", 
                options: [
                    "Langsung klik.", 
                    "Forward ke grup.", 
                    "Analisis domain URL (bukan .go.id berarti mencurigakan).", 
                    "Tanya pengirim."
                ], 
                correctAnswer: 2 
            },
            { 
                id: 5, category: 'mc', type: 'choice', 
                question: "Miskonsepsi: Apa batasan keamanan 'Incognito Mode' yang sering disalahpahami pengguna?", 
                options: [
                    "Incognito hanya mencegah browser menyimpan history lokal, tapi ISP/Admin tetap bisa melihat aktivitas.", 
                    "Merekam password diam-diam.", 
                    "Memperlambat internet.", 
                    "Menghapus akun otomatis."
                ], 
                correctAnswer: 0 
            },
            { 
                id: 6, category: 'mc', type: 'choice', 
                question: "Isu Sosial: Apa risiko jangka panjang terbesar dari 'Sharenting' (Orang tua oversharing foto anak) bagi anak?", 
                options: [
                    "Memori penuh.", 
                    "Hilangnya hak privasi anak & risiko penyalahgunaan data (profiling).", 
                    "Anak jadi artis.", 
                    "Kehilangan hak asuh."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 7, category: 'mc', type: 'choice', 
                question: "Dunia Kerja: Pelamar kerja ditolak perusahaan karena jejak digital, padahal nilai akademiknya bagus. Faktor penyebab paling mungkin?", 
                options: [
                    "Jarang update status.", 
                    "Followers sedikit.", 
                    "Ditemukan ujaran kebencian atau perilaku tidak etis di postingan masa lalu.", 
                    "Pakai nama asli."
                ], 
                correctAnswer: 2 
            },
            { 
                id: 8, category: 'mc', type: 'choice', 
                question: "Strategi: Langkah paling efektif untuk membangun reputasi digital positif adalah...", 
                options: [
                    "Buat akun palsu memuji diri.", 
                    "Aktif mengunggah karya, prestasi, atau konten edukatif.", 
                    "Kunci akun selamanya.", 
                    "Hapus semua jejak."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 9, category: 'mc', type: 'choice', 
                question: "Konsep: Perbedaan utama Jejak Digital Aktif vs Pasif?", 
                options: [
                    "Waktu kejadian.", 
                    "Intensi (Kesadaran): Aktif dilakukan sadar, Pasif direkam sistem otomatis.", 
                    "Bisa dihapus vs Tidak.", 
                    "Teks vs Gambar."
                ], 
                correctAnswer: 1 
            },
            { 
                id: 10, category: 'mc', type: 'choice', 
                question: "Keamanan: Mengapa tanggal lahir dilarang digunakan sebagai PIN/Password?", 
                options: [
                    "Data publik mudah ditebak (Social Engineering).", 
                    "Angka sial.", 
                    "Komputer sulit baca.", 
                    "Terlalu pendek."
                ], 
                correctAnswer: 0 
            },
            
            // --- B. BENAR / SALAH ---
            { id: 13, category: 'bs', type: 'choice', question: "(B/S) Menggunakan VPN Gratis menjamin 100% data aman dari penyedia VPN itu sendiri.", options: ["Benar", "Salah (Penyedia bisa catat log)"], correctAnswer: 1 },
            { id: 14, category: 'bs', type: 'choice', question: "(B/S) Server web mencatat alamat IP perangkat saat berkunjung adalah contoh Jejak Digital Pasif.", options: ["Benar", "Salah"], correctAnswer: 0 },

            // --- C. MENJODOHKAN (4 Pasang) ---
            { 
                id: 15, category: 'match', type: 'complex_match', question: "Pasangkan jenis Ancaman Siber:", 
                pairs: [{ left: "Phishing", right: "Link Palsu" }, { left: "Doxing", right: "Sebar Data Pribadi" }, { left: "Sniffing", right: "Penyadapan Data" }, { left: "Defacing", right: "Peretasan Web" }] 
            },
            { 
                id: 16, category: 'match', type: 'complex_match', question: "Jodohkan aktivitas jejak digital:", 
                pairs: [{ left: "Jejak Aktif", right: "Posting Status" }, { left: "Jejak Pasif", right: "History Browser" }, { left: "Metadata", right: "Lokasi Foto" }, { left: "Cookies", right: "Simpan Login" }] 
            },
            { 
                id: 17, category: 'match', type: 'complex_match', question: "Pasangkan fitur keamanan:", 
                pairs: [{ left: "2FA", right: "Kode OTP" }, { left: "Password Manager", right: "Simpan Sandi Rumit" }, { left: "Incognito", right: "Tanpa History Lokal" }, { left: "VPN", right: "Samarkan IP" }] 
            },
            { 
                id: 18, category: 'match', type: 'complex_match', question: "Jodohkan istilah Etika Digital:", 
                pairs: [{ left: "Cyberbullying", right: "Perundungan" }, { left: "Plagiarisme", right: "Curi Karya" }, { left: "Hate Speech", right: "Ujaran Kebencian" }, { left: "Hoaks", right: "Berita Bohong" }] 
            },
            { 
                id: 19, category: 'match', type: 'complex_match', question: "Pasangkan Risiko File:", 
                pairs: [{ left: ".exe", right: "Sangat Berisiko" }, { left: ".jpg", right: "Risiko Rendah" }, { left: ".pdf", right: "Risiko Sedang" }, { left: ".zip", right: "Perlu Scan" }] 
            },

            // --- D. URAIAN / ESSAY ---
            { id: 28, category: 'essay', type: 'essay', question: "Studi Kasus: Universitas menolak calon mahasiswa berprestasi karena jejak digital rasis di masa lalu. Analisislah mengapa 'Rekam Jejak Digital' kini dianggap sepenting prestasi akademik!", keywords: ["karakter", "reputasi", "integritas", "etika", "citra"], minKeywords: 2 },
            { id: 29, category: 'essay', type: 'essay', question: "Analisis Privasi: Fitur 'Live Location' berguna untuk keamanan tapi melacak pola hidup. Jelaskan dilema 'Kenyamanan vs Privasi' ini dan cara bijak menggunakannya!", keywords: ["izin akses", "hanya saat digunakan", "matikan", "kesadaran"], minKeywords: 2 },
            { id: 30, category: 'essay', type: 'essay', question: "Problem Solving: Kamu menemukan akun palsu (impersonation) menggunakan namamu untuk menipu. Rumuskan 3 langkah darurat yang efektif!", keywords: ["lapor", "report", "blokir", "klarifikasi", "screenshot"], minKeywords: 3 },
            { id: 31, category: 'essay', type: 'essay', question: "Evaluasi: Bantahlah argumen 'Saya tidak punya rahasia jadi tidak takut diawasi' dengan menjelaskan bahaya 'Profiling Data' dari jejak pasif!", keywords: ["manipulasi", "target iklan", "pencurian identitas", "prediksi"], minKeywords: 2 },
            { id: 32, category: 'essay', type: 'essay', question: "Analisis Hukum: Mengapa komentar penghinaan fisik 'iseng' bisa dipidana UU ITE? Jelaskan unsur yang dilanggar!", keywords: ["pencemaran", "ujaran kebencian", "sara", "pidana"], minKeywords: 2 },
            { id: 33, category: 'essay', type: 'essay', question: "Keamanan Siber: Mengapa menggunakan tanggal lahir sebagai Password disebut 'Dosa Besar'? Hubungkan dengan Social Engineering!", keywords: ["data publik", "mudah ditebak", "lemah", "brute force"], minKeywords: 2 },
            { id: 34, category: 'essay', type: 'essay', question: "Konsep Baru: Apa itu 'Digital Legacy' dan mengapa kita perlu mengatur akun kita jika kita meninggal dunia?", keywords: ["data pasca mati", "penyalahgunaan", "ahli waris", "memorialization"], minKeywords: 2 }
        ];

        // --- UTILS ---
        const shuffleArray = (array) => [...array].sort(() => Math.random() - 0.5);
        const simulateAIAnalysis = async (ans, keys, min) => new Promise(r => setTimeout(() => {
            if(!ans || ans.length < 10) return r({score: 0, feedback: "Jawaban terlalu singkat, jelaskan lebih detail."});
            const h = keys.filter(k => ans.toLowerCase().includes(k)).length;
            r({score: h >= min ? 100 : h > 0 ? 50 : 20, feedback: "Dinilai oleh AI."});
        }, 800));

        // ==========================================
        // COMPONENTS
        // ==========================================

        function LoginScreen({ onLogin }) {
            const [isAdmin, setIsAdmin] = useState(false);
            const [form, setForm] = useState({ name: '', pass: '', kelas: '', absen: '' });

            const handleSubmit = () => {
                if (isAdmin) {
                    if (form.pass === 'admin123') onLogin('Guru Admin', 'admin');
                    else alert('Password salah!');
                } else {
                    if (form.name && form.kelas && form.absen) onLogin(form.name.toUpperCase(), 'student', { kelas: form.kelas, absen: form.absen });
                    else alert('Lengkapi data siswa!');
                }
            };

            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-md shadow-lg w-full max-w-sm overflow-hidden border-t-4 border-cbtBlue">
                        <div className="bg-slate-50 p-6 text-center border-b border-slate-200">
                            <h1 className="text-xl font-bold text-slate-800 uppercase tracking-tight">CBT Informatika</h1>
                            <p className="text-xs text-slate-500 mt-1">Computer Based Test</p>
                        </div>
                        <div className="bg-red-50 p-3 mx-4 mt-4 border border-red-200 rounded text-xs text-red-700 flex items-start gap-2">
                            <Icon path={Icons.Alert} className="w-5 h-5 shrink-0 mt-0.5"/>
                            <span><strong>ANTI-CHEAT:</strong> Pindah tab/minimize = <strong>RESET & DICATAT!</strong></span>
                        </div>
                        <div className="p-6 space-y-4">
                            <div className="flex bg-slate-100 p-1 rounded mb-2">
                                <button onClick={() => setIsAdmin(false)} className={`flex-1 py-1.5 text-xs font-bold rounded transition ${!isAdmin ? 'bg-white text-cbtBlue shadow-sm' : 'text-slate-500'}`}>SISWA</button>
                                <button onClick={() => setIsAdmin(true)} className={`flex-1 py-1.5 text-xs font-bold rounded transition ${isAdmin ? 'bg-white text-cbtBlue shadow-sm' : 'text-slate-500'}`}>GURU</button>
                            </div>
                            {!isAdmin ? (
                                <>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-600 mb-1">Nama Lengkap</label>
                                        <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value.toUpperCase()})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue focus:ring-1 focus:ring-cbtBlue outline-none uppercase" placeholder="Masukkan Nama" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">Kelas</label>
                                            <select value={form.kelas} onChange={e => setForm({...form, kelas: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none bg-white">
                                                <option value="">- Pilih -</option>
                                                {['VIII-A','VIII-B','VIII-C','VIII-D','VIII-E','VIII-F','VIII-G','VIII-H'].map(k => <option key={k} value={k}>{k}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-600 mb-1">Absen</label>
                                            <input type="number" value={form.absen} onChange={e => setForm({...form, absen: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none" placeholder="1-40" />
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div>
                                    <label className="block text-xs font-bold text-slate-600 mb-1">Password Admin</label>
                                    <input type="password" value={form.pass} onChange={e => setForm({...form, pass: e.target.value})} className="w-full p-2 text-sm border border-slate-300 rounded focus:border-cbtBlue outline-none" />
                                </div>
                            )}
                            <button onClick={handleSubmit} className="w-full py-2.5 bg-cbtBlue hover:bg-blue-700 text-white rounded font-bold text-sm shadow-sm mt-4">LOGIN</button>
                        </div>
                    </div>
                </div>
            );
        }

        function StudentDashboard({ user, onStart }) {
            // Cek jika ada riwayat pelanggaran sebelumnya
            const violationKey = `cbt_violation_${user.name}_${user.kelas}`;
            const previousViolations = parseInt(localStorage.getItem(violationKey) || '0');

            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded-md shadow-lg w-full max-w-lg overflow-hidden border border-slate-200">
                        <div className="bg-cbtBlue p-4 text-white flex items-center justify-between">
                            <h2 className="font-bold text-lg">Konfirmasi Data</h2>
                            <Icon path={Icons.User} className="w-5 h-5 opacity-80" />
                        </div>
                        <div className="p-6">
                            <table className="w-full text-sm mb-6">
                                <tbody>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500 w-32">Nama Peserta</td><td className="py-2 font-bold">{user.name}</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Kelas / Absen</td><td className="py-2 font-bold">{user.kelas} / {user.absen}</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Mata Pelajaran</td><td className="py-2 font-bold">Informatika</td></tr>
                                    <tr className="border-b border-slate-100"><td className="py-2 text-slate-500">Jumlah Soal</td><td className="py-2 font-bold">24 Butir</td></tr>
                                    <tr><td className="py-2 text-slate-500">Waktu</td><td className="py-2 font-bold">40 Menit</td></tr>
                                </tbody>
                            </table>
                            
                            {previousViolations > 0 && (
                                <div className="bg-red-50 border border-red-200 p-3 rounded mb-4 text-xs text-red-800 flex items-center gap-2">
                                    <Icon path={Icons.Alert} className="w-4 h-4"/>
                                    <span>Anda tercatat melakukan <strong>{previousViolations}x Pelanggaran (Reset)</strong> sebelumnya.</span>
                                </div>
                            )}

                            <div className="bg-blue-50 border border-blue-200 p-3 rounded mb-6 text-sm text-blue-800">
                                <strong>Info:</strong> Fitur refresh aman (soal tersimpan). Namun, dilarang pindah tab/aplikasi atau ujian reset otomatis.
                            </div>
                            <button onClick={onStart} className="w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded font-bold text-sm shadow-sm">MULAI UJIAN</button>
                        </div>
                    </div>
                </div>
            );
        }

        function ExamInterface({ questions, answers, setAnswers, onSubmit, timeLeft, currentIndex, setCurrentIndex, isSubmitting }) {
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [selectedAnswer, setSelectedAnswer] = useState(null); 
            
            // Safety Check
            if (!questions || questions.length === 0 || !questions[currentIndex]) {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                        <div className="w-12 h-12 border-4 border-cbtBlue border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p className="text-slate-600 font-bold">Memuat Soal...</p>
                        <button onClick={() => { localStorage.removeItem('cbt_active_exam'); window.location.reload(); }} className="mt-4 text-xs text-blue-500 hover:underline">Reset & Refresh</button>
                    </div>
                );
            }

            const q = questions[currentIndex];
            const isLast = currentIndex === questions.length - 1;
            const isFirst = currentIndex === 0;

            const formatTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
            const handleNext = () => !isLast && setCurrentIndex(currentIndex + 1);
            const handlePrev = () => !isFirst && setCurrentIndex(currentIndex - 1);
            const handleMatchClick = t => setSelectedAnswer(selectedAnswer === t ? null : t);
            const handleSlotClick = i => { if(selectedAnswer) { const p = answers[q.id] || {}; setAnswers({...answers, [q.id]: {...p, [i]: selectedAnswer}}); setSelectedAnswer(null); }};
            const removeMatch = i => { const p = {...answers[q.id]}; delete p[i]; setAnswers({...answers, [q.id]: p}); };

            if(isSubmitting) return <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-center justify-center text-white"><div className="w-10 h-10 border-4 border-white border-t-transparent rounded-full animate-spin mb-3"></div><span className="font-bold">Menyimpan...</span></div>;

            return (
                <div className="h-screen flex flex-col bg-slate-100 font-sans text-sm">
                    <header className="bg-cbtBlue text-white h-12 flex items-center justify-between px-3 shadow-md shrink-0 z-20">
                        <div className="flex items-center gap-2"><span className="font-bold text-lg">CBT</span><span className="bg-blue-500 px-2 py-0.5 rounded text-xs">Informatika</span></div>
                        <div className="flex items-center gap-2 bg-blue-700/50 px-2 py-1 rounded"><Icon path={Icons.Clock} className="w-4 h-4"/><span className="font-mono font-bold">{formatTime(timeLeft)}</span></div>
                    </header>
                    <div className="flex-1 flex overflow-hidden relative">
                        {/* Drawer */}
                        <div className={`absolute inset-y-0 left-0 w-64 bg-white shadow-xl transform transition-transform z-30 lg:relative lg:transform-none lg:w-72 lg:border-r border-slate-300 flex flex-col ${drawerOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                            <div className="p-3 border-b flex justify-between lg:hidden"><span className="font-bold">Navigasi</span><button onClick={()=>setDrawerOpen(false)}><Icon path={Icons.X} className="w-5 h-5"/></button></div>
                            <div className="flex-1 overflow-y-auto p-3 grid grid-cols-5 gap-2 content-start">
                                {questions.map((qn, idx) => {
                                    const filled = qn.type === 'complex_match' ? (answers[qn.id] && Object.keys(answers[qn.id]).length === 4) : (answers[qn.id] !== undefined && answers[qn.id] !== "");
                                    return <button key={qn.id} onClick={()=>{setCurrentIndex(idx);setDrawerOpen(false)}} className={`h-8 rounded border font-bold text-xs ${idx===currentIndex?'bg-cbtBlue text-white':filled?'bg-green-100 text-green-700':'bg-white text-slate-500'}`}>{idx+1}</button>
                                })}
                            </div>
                        </div>
                        {drawerOpen && <div className="fixed inset-0 bg-black/50 z-20 lg:hidden" onClick={()=>setDrawerOpen(false)}></div>}
                        <main className="flex-1 overflow-y-auto bg-slate-200 p-2 md:p-4">
                            <div className="bg-white rounded shadow-sm border border-slate-300 min-h-full flex flex-col">
                                <div className="p-3 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                                    <div className="flex gap-2"><button onClick={()=>setDrawerOpen(true)} className="lg:hidden p-1 bg-white border rounded"><Icon path={Icons.Menu} className="w-5 h-5"/></button><span className="font-bold">Soal No. {currentIndex+1}</span></div>
                                    <span className="text-[10px] font-bold px-2 py-0.5 bg-slate-200 rounded uppercase">{q.type === 'complex_match' ? 'JODOHKAN' : q.type}</span>
                                </div>
                                <div className="p-4 md:p-6 flex-1 text-base">
                                    <div className="mb-5 font-medium text-slate-800 question-text whitespace-pre-wrap">
                                        {q.category === 'essay' || q.category === 'mc' ? <div className="question-highlight">Perhatikan studi kasus berikut dengan saksama.</div> : null}
                                        {q.question}
                                    </div>
                                    
                                    {/* PG / BS */}
                                    {q.type === 'choice' && <div className="space-y-2">{q.options.map((opt, idx) => (
                                        <div key={idx} onClick={()=>setAnswers({...answers, [q.id]: idx})} className={`flex gap-3 p-3 rounded border cursor-pointer hover:bg-slate-50 ${answers[q.id]===idx?'bg-blue-50 border-cbtBlue ring-1 ring-cbtBlue':'bg-white'}`}>
                                            <div className={`w-5 h-5 rounded-full border flex items-center justify-center shrink-0 ${answers[q.id]===idx?'bg-cbtBlue border-cbtBlue':'border-slate-400'}`}>{answers[q.id]===idx && <div className="w-2 h-2 bg-white rounded-full"></div>}</div><span className="option-text">{opt}</span>
                                        </div>
                                    ))}</div>}

                                    {/* MATCH */}
                                    {q.type === 'complex_match' && <div className="space-y-4">
                                        <div className="grid gap-2">{q.pairs.map((pair, idx) => {
                                            const filled = answers[q.id]?.[idx];
                                            return <div key={idx} className="flex flex-col sm:flex-row border rounded bg-white overflow-hidden">
                                                <div className="sm:w-1/2 p-2 bg-slate-50 border-b sm:border-b-0 sm:border-r text-sm font-medium flex items-center gap-2"><span className="bg-slate-200 text-xs w-5 h-5 flex items-center justify-center rounded font-bold">{String.fromCharCode(65+idx)}</span>{pair.left}</div>
                                                <div onClick={()=>handleSlotClick(idx)} className={`sm:w-1/2 p-2 min-h-[40px] flex items-center justify-center cursor-pointer ${filled?'bg-blue-50':selectedAnswer?'bg-yellow-50 border-dashed border-yellow-400':''}`}>{filled ? <div className="flex justify-between w-full px-2"><span className="text-blue-700 font-bold text-sm">{filled}</span><button onClick={(e)=>{e.stopPropagation();removeMatch(idx)}} className="text-red-500"><Icon path={Icons.X} className="w-4 h-4"/></button></div> : <span className="text-xs text-slate-300 font-bold">{selectedAnswer?"PILIH SINI":"KOSONG"}</span>}</div>
                                            </div>
                                        })}</div>
                                        <div className="bg-slate-100 p-3 rounded border"><p className="text-xs font-bold text-center mb-2">KLIK JAWABAN:</p><div className="flex flex-wrap gap-2 justify-center">{q.shuffledAnswers.map((ans,i) => {
                                            const used = Object.values(answers[q.id]||{}).includes(ans);
                                            return <button key={i} disabled={used} onClick={()=>setSelectedAnswer(selectedAnswer===ans?null:ans)} className={`px-3 py-1.5 rounded border text-sm font-bold shadow-sm ${used?'bg-slate-200 text-slate-400 border-slate-200 cursor-not-allowed' : selectedAnswer===ans?'bg-cbtBlue text-white':'bg-white hover:border-blue-500'}`}>{ans}</button>
                                        })}</div></div>
                                    </div>}

                                    {/* ESSAY */}
                                    {q.type === 'essay' && <textarea value={answers[q.id]||''} onChange={e=>setAnswers({...answers, [q.id]: e.target.value})} className="w-full h-48 p-3 border rounded focus:border-cbtBlue outline-none text-sm" placeholder="Tulis jawaban lengkap Anda di sini..."></textarea>}
                                </div>
                                <div className="p-3 border-t bg-slate-50 flex justify-between">
                                    {!isFirst ? <button onClick={handlePrev} className="px-4 py-2 bg-white border rounded font-bold text-sm shadow-sm flex items-center gap-1"><Icon path={Icons.Left} className="w-4 h-4"/> Prev</button> : <div></div>}
                                    {isLast ? <button onClick={()=>confirm("Selesai?") && onSubmit()} className="px-6 py-2 bg-red-600 text-white rounded font-bold text-sm shadow-sm flex items-center gap-1">SELESAI <Icon path={Icons.Check} className="w-4 h-4"/></button> : <button onClick={handleNext} className="px-6 py-2 bg-cbtBlue text-white rounded font-bold text-sm shadow-sm flex items-center gap-1">Next <Icon path={Icons.Right} className="w-4 h-4"/></button>}
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
            );
        }

        function ResultScreen({ score, user, onHome }) {
            return (
                <div className="min-h-screen bg-slate-200 flex items-center justify-center p-4">
                    <div className="bg-white rounded shadow-lg p-8 max-w-sm w-full text-center border-t-4 border-cbtBlue">
                        <h2 className="text-xl font-bold mb-2">UJIAN SELESAI</h2>
                        <p className="text-sm text-slate-500 mb-6">Jawaban Anda telah tersimpan.</p>
                        <div className="bg-slate-50 border rounded p-4 mb-6">
                            <span className="block text-xs font-bold text-slate-400 uppercase">Skor Anda</span>
                            <span className={`block text-5xl font-black mt-2 ${score>=75?'text-green-600':'text-red-600'}`}>{score}</span>
                        </div>
                        <button onClick={onHome} className="w-full py-2 bg-slate-800 text-white rounded font-bold text-sm hover:bg-slate-900">KELUAR</button>
                    </div>
                </div>
            );
        }

        // --- VIEW DETAIL MODAL ---
        function ViewDetailModal({ data, onClose }) {
            if (!data) return null;
            const details = data.detail && data.detail.answers ? data.detail.answers : []; // Structure changed, now object
            const violations = data.detail && data.detail.violations ? data.detail.violations : 0;

            return (
                <div className="fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-3xl h-[80vh] flex flex-col overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="font-bold text-lg text-slate-800">{data.name}</h3>
                                <p className="text-xs text-slate-500">{data.kelas} | Skor: {data.score}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full"><Icon path={Icons.X} className="w-5 h-5 text-slate-600"/></button>
                        </div>
                        
                        {violations > 0 && (
                            <div className="bg-red-50 p-3 border-b border-red-100 flex items-center justify-center gap-2 text-red-700 text-sm font-bold">
                                <Icon path={Icons.Alert} className="w-5 h-5"/>
                                Siswa ini melakukan {violations}x Pelanggaran (Reset/Multi-tab)
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {details.length === 0 ? (
                                <p className="text-center text-slate-400 italic">Detail jawaban tidak tersedia.</p>
                            ) : (
                                details.map((item, idx) => (
                                    <div key={idx} className="border-b border-slate-100 pb-4 last:border-0">
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold text-sm text-cbtBlue">Soal {idx+1} ({item.type})</span>
                                            <span className={`text-xs px-2 py-0.5 rounded font-bold ${item.status?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{item.status?'Benar':'Salah'}</span>
                                        </div>
                                        <p className="text-sm text-slate-700 mb-3 whitespace-pre-wrap">{item.q}</p>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                            <div className="bg-slate-50 p-3 rounded border border-slate-200"><span className="text-xs font-bold text-slate-400 block mb-1">JAWABAN SISWA</span><pre className="whitespace-pre-wrap font-sans text-slate-800">{item.ans}</pre></div>
                                            <div className="bg-green-50 p-3 rounded border border-green-200"><span className="text-xs font-bold text-green-600 block mb-1">KUNCI</span><pre className="whitespace-pre-wrap font-sans text-green-800">{item.key}</pre></div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- ADMIN PANEL ---
        function AdminPanel({ onLogout }) {
            const [data, setData] = useState([]);
            const [selectedData, setSelectedData] = useState(null);

            useEffect(() => {
                if(supabaseClient) supabaseClient.from('exam_results').select('*').order('created_at', { ascending: false }).then(({ data }) => setData(data || []));
                else setData(JSON.parse(localStorage.getItem('cbt_local_results') || '[]'));
            }, []);

            const download = () => {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nilai");
                XLSX.writeFile(wb, "Rekap.xlsx");
            };

            return (
                <div className="min-h-screen bg-slate-100 p-4">
                    <div className="max-w-6xl mx-auto bg-white rounded shadow-sm border border-slate-200">
                        <div className="p-4 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 bg-slate-50">
                            <div><h2 className="font-bold text-slate-700 text-lg">PANEL GURU</h2></div>
                            <div className="flex gap-2"><button onClick={download} className="px-3 py-1.5 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700">EXCEL</button><button onClick={onLogout} className="px-3 py-1.5 bg-slate-700 text-white rounded text-xs font-bold hover:bg-slate-800">LOGOUT</button></div>
                        </div>
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-slate-600 border-b border-slate-200 font-bold"><tr><th className="p-3">Waktu</th><th className="p-3">Nama</th><th className="p-3">Kelas</th><th className="p-3">Nilai</th><th className="p-3">Status</th><th className="p-3 text-center">Aksi</th></tr></thead>
                        <tbody className="divide-y divide-slate-100">{data.map((r,i)=> {
                             const violations = r.detail?.violations || 0;
                             return (
                                <tr key={i} className="hover:bg-blue-50/50">
                                    <td className="p-3 text-slate-500">{new Date(r.created_at||r.date).toLocaleString()}</td>
                                    <td className="p-3 font-bold text-slate-800">{r.name}</td>
                                    <td className="p-3">{r.kelas}</td>
                                    <td className="p-3 font-bold text-cbtBlue">{r.score}</td>
                                    <td className="p-3">
                                        {violations > 0 ? 
                                            <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full border border-red-200 font-bold flex items-center w-fit gap-1"><Icon path={Icons.Alert} className="w-3 h-3"/> {violations}x Reset</span> 
                                            : <span className="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full border border-green-200 font-bold">Aman</span>
                                        }
                                    </td>
                                    <td className="p-3 text-center"><button onClick={()=>setSelectedData(r)} className="text-cbtBlue hover:text-blue-800 flex items-center justify-center mx-auto gap-1 text-xs font-bold"><Icon path={Icons.Eye} className="w-4 h-4"/> Detail</button></td>
                                </tr>
                             )
                        })}</tbody></table></div>
                    </div>
                    {selectedData && <ViewDetailModal data={selectedData} onClose={()=>setSelectedData(null)} />}
                </div>
            );
        }

        // --- APP CONTROLLER ---
        function App() {
            const [state, setState] = useState({ view: 'login', user: null, questions: [], answers: {}, score: 0, timeLeft: 40*60, currentIndex: 0 });
            const [submitting, setSubmitting] = useState(false);
            const [loading, setLoading] = useState(true);

            // ANTI CHEAT: VISIBILITY CHANGE LISTENER
            useEffect(() => {
                const handleVisibilityChange = () => {
                    if (document.hidden && state.view === 'exam') {
                        // 1. Catat Pelanggaran di LocalStorage (Persistent walau di-refresh)
                        const key = `cbt_violation_${state.user.name}_${state.user.kelas}`;
                        const currentCount = parseInt(localStorage.getItem(key) || '0');
                        localStorage.setItem(key, currentCount + 1);

                        alert(`PELANGGARAN TERDETEKSI! (Total: ${currentCount + 1}x)\n\nAnda meninggalkan halaman ujian (pindah tab/minimize). Sesi Anda telah dibatalkan dan akan di-reset ke Dashboard.`);
                        localStorage.removeItem('cbt_active_exam');
                        // Reset to dashboard for student, clear questions to force reshuffle next time
                        // Force reload to clean state completely
                        window.location.reload();
                    }
                };
                document.addEventListener('visibilitychange', handleVisibilityChange);
                return () => document.removeEventListener('visibilitychange', handleVisibilityChange);
            }, [state.view, state.user]);

            // Load Session (Persistence for Refresh only)
            useEffect(() => {
                const s = localStorage.getItem('cbt_active_exam');
                if(s) { 
                    try { 
                        const parsed = JSON.parse(s);
                        // If exam data exists and valid, restore it (allows refresh)
                        if(parsed.view === 'exam' && parsed.questions && parsed.questions.length > 0) {
                             setState(parsed); 
                        } else if (parsed.user) {
                             // If just user data but no active exam, go to dashboard
                             setState(p => ({...p, user: parsed.user, view: parsed.user.role === 'admin' ? 'admin' : 'dashboard'}));
                        }
                    } catch(e) { localStorage.removeItem('cbt_active_exam'); } 
                }
                setLoading(false);
            }, []);

            // Save Session on Change
            useEffect(() => {
                if(state.user) localStorage.setItem('cbt_active_exam', JSON.stringify(state));
            }, [state]);

            // Timer
            useEffect(() => {
                if(state.view === 'exam' && state.timeLeft > 0) {
                    const t = setInterval(() => setState(p => ({...p, timeLeft: p.timeLeft - 1})), 1000);
                    return () => clearInterval(t);
                } else if(state.timeLeft === 0 && state.view === 'exam') submit();
            }, [state.view, state.timeLeft]);

            const startExam = () => {
                const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
                const qMc = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'mc')).slice(0, 8);
                const qBs = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'bs')).slice(0, 2);
                const qMatch = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'match')).slice(0, 5).map(q => ({
                    ...q, shuffledAnswers: shuffle(q.pairs.map(p => p.right))
                }));
                const qEssay = shuffle(INITIAL_QUESTIONS.filter(q => q.category === 'essay')).slice(0, 7);
                
                setState(p => ({...p, view: 'exam', questions: [...qMc, ...qBs, ...qMatch, ...qEssay], answers: {}, timeLeft: 40*60, currentIndex: 0}));
            };

            const submit = async () => {
                setSubmitting(true);
                let score = 0;
                
                const report = state.questions.map(q => {
                    const ansIdx = state.answers[q.id];
                    let u="-", k="-", ok=false, pts=0;
                    if (q.type === 'choice') {
                        u = q.options[ansIdx] || "Tidak Dijawab"; k = q.options[q.correctAnswer];
                        if (ansIdx === q.correctAnswer) { ok=true; pts=1; }
                    } else if (q.type === 'complex_match') {
                        const pairs = q.pairs.map((p, idx) => { const v=(ansIdx||{})[idx]||"-"; if(v===p.right) pts+=0.25; return `${p.left}->${v}`; });
                        u=pairs.join('\n'); k="Lihat Soal"; if(pts>=1) ok=true;
                    } else if (q.type === 'essay') {
                        u=ansIdx||""; k=q.keywords.join(", "); 
                        if(u.length>5) { const h=q.keywords.filter(w=>u.toLowerCase().includes(w)).length; if(h>=q.minKeywords){pts=1;ok=true;} else if(h>0) pts=0.5; }
                    }
                    score += pts;
                    return { q: q.question, type: q.type, ans: u, key: k, status: ok };
                });

                const finalScore = Math.round((score / state.questions.length) * 100);
                
                // Ambil Jumlah Pelanggaran
                const vKey = `cbt_violation_${state.user.name}_${state.user.kelas}`;
                const violations = parseInt(localStorage.getItem(vKey) || '0');

                // Format Detail Baru (Objek)
                const finalDetail = {
                    answers: report,
                    violations: violations
                };
                
                if(supabaseClient) await supabaseClient.from('exam_results').insert([{ name: state.user.name, kelas: state.user.kelas, absen: state.user.absen, score: finalScore, detail: finalDetail }]);
                else {
                    const local = JSON.parse(localStorage.getItem('cbt_local_results')||'[]');
                    local.push({ name: state.user.name, kelas: state.user.kelas, score: finalScore, date: new Date(), detail: finalDetail });
                    localStorage.setItem('cbt_local_results', JSON.stringify(local));
                }

                // Clear violation count after success submission
                localStorage.removeItem(vKey);
                localStorage.removeItem('cbt_active_exam');
                setState(p => ({...p, view: 'result', score: finalScore}));
                setSubmitting(false);
            };

            const logout = () => { localStorage.removeItem('cbt_active_exam'); setState({view:'login', user:null}); };

            if(loading) return <div className="flex h-screen items-center justify-center bg-slate-50 flex-col"><div className="w-10 h-10 border-4 border-cbtBlue border-t-transparent rounded-full animate-spin mb-3"></div><span className="text-slate-500 font-bold text-sm">MEMUAT...</span></div>;

            if(state.view === 'login') return <LoginScreen onLogin={(n,r,d) => setState(p => ({...p, user:{name:n, role:r, ...d}, view: r==='admin'?'admin':'dashboard'}))} />;
            if(state.view === 'dashboard') return <StudentDashboard user={state.user} onStart={startExam} />;
            if(state.view === 'exam') return <ExamInterface questions={state.questions} answers={state.answers} setAnswers={a => setState(p => ({...p, answers: a}))} timeLeft={state.timeLeft} currentIndex={state.currentIndex} setCurrentIndex={i => setState(p => ({...p, currentIndex: i}))} onSubmit={submit} isSubmitting={submitting} />;
            if(state.view === 'result') return <ResultScreen score={state.score} user={state.user} onHome={logout} />;
            if(state.view === 'admin') return <AdminPanel onLogout={logout} />;
            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
